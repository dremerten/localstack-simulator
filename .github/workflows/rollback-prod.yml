name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to deploy (e.g. v1.2 or v1.2.3)"
        required: true

permissions:
  contents: read

env:
  IMAGE_REPO: ${{ secrets.DOCKER_IMAGE_REPO }}

jobs:
  rollback_production:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set release tag
        run: |
          release_tag="${{ github.event.inputs.release_tag }}"
          if ! echo "$release_tag" | grep -Eq '^v[0-9]+\.[0-9]+(\.[0-9]+)?$'; then
            echo "release_tag must look like v1.2 or v1.2.3" >&2
            exit 1
          fi
          echo "RELEASE_TAG=${release_tag}" >> "$GITHUB_ENV"

      - name: Ensure required secrets
        run: |
          test -n "${IMAGE_REPO}" || { echo "DOCKER_IMAGE_REPO secret is required"; exit 1; }

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify release tag exists
        run: |
          if ! docker manifest inspect "${IMAGE_REPO}:${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Release image ${IMAGE_REPO}:${RELEASE_TAG} not found." >&2
            exit 1
          fi

      - uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Write kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_PROD_B64 }}
        run: |
          mkdir -p ~/.kube
          echo "$KUBECONFIG_B64" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy rollback to production
        env:
          ACME_EMAIL: ${{ secrets.ACME_EMAIL }}
          ACME_MODE: ${{ secrets.ACME_MODE || 'prod' }}
          APP_DOMAIN: ${{ secrets.APP_DOMAIN }}
          APP_NAMESPACE: ${{ secrets.APP_NAMESPACE || 'iac-sandbox-prod' }}
          PUBLIC_IP: ${{ secrets.PUBLIC_IP }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_EMAIL: ${{ secrets.DOCKERHUB_EMAIL }}
          GATEWAY_NAMESPACE: ${{ secrets.GATEWAY_NAMESPACE }}
          GATEWAY_SERVICE: ${{ secrets.GATEWAY_SERVICE }}
          SANDBOX_IMAGE: ${{ env.IMAGE_REPO }}:${{ env.RELEASE_TAG }}
        run: ./scripts/apply-staging.sh
